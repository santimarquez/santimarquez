---
interface Props {
  t: (key: string) => string;
  successMessage: string;
  errorMessage: string;
}

const { t, successMessage, errorMessage } = Astro.props;
---

<div id="contact-form-container" class="max-w-2xl" data-contact-success-msg={successMessage} data-contact-error-msg={errorMessage}>
  <form id="contact-form" class="space-y-6" aria-label={t('contact.title')}>
    <div class="grid gap-6 sm:grid-cols-2">
      <div>
        <label for="contact-name" class="block text-xs font-medium uppercase tracking-wider text-charcoal dark:text-slate-300">{t('contact.name')}</label>
        <input type="text" id="contact-name" name="name" required autocomplete="name" placeholder={t('contact.namePlaceholder')} class="mt-2 block w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-charcoal placeholder:text-charcoal-light focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:placeholder:text-slate-500" />
        <span id="contact-name-error" class="mt-1 hidden text-sm text-red-600 dark:text-red-400" aria-live="polite"></span>
      </div>
      <div>
        <label for="contact-email" class="block text-xs font-medium uppercase tracking-wider text-charcoal dark:text-slate-300">{t('contact.email')}</label>
        <input type="email" id="contact-email" name="email" required autocomplete="email" placeholder={t('contact.emailPlaceholder')} class="mt-2 block w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-charcoal placeholder:text-charcoal-light focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:placeholder:text-slate-500" />
        <span id="contact-email-error" class="mt-1 hidden text-sm text-red-600 dark:text-red-400" aria-live="polite"></span>
      </div>
    </div>
    <div>
      <label for="contact-message" class="block text-xs font-medium uppercase tracking-wider text-charcoal dark:text-slate-300">{t('contact.message')}</label>
      <textarea id="contact-message" name="message" required rows="4" placeholder={t('contact.messagePlaceholder')} class="mt-2 block w-full rounded-lg border border-slate-300 bg-white px-4 py-3 text-charcoal placeholder:text-charcoal-light focus:border-accent focus:outline-none focus:ring-1 focus:ring-accent dark:border-slate-600 dark:bg-slate-800 dark:text-slate-100 dark:placeholder:text-slate-500"></textarea>
      <span id="contact-message-error" class="mt-1 hidden text-sm text-red-600 dark:text-red-400" aria-live="polite"></span>
    </div>
    <button type="submit" id="contact-submit-btn" class="inline-flex items-center justify-center gap-2 rounded-lg bg-charcoal px-6 py-3 text-sm font-medium uppercase tracking-wider text-white shadow-sm transition hover:bg-charcoal-light focus:outline-none focus:ring-2 focus:ring-accent focus:ring-offset-2 disabled:opacity-80 disabled:pointer-events-none dark:bg-slate-100 dark:text-charcoal dark:hover:bg-slate-200">
      <span class="contact-btn-text">{t('contact.send')}</span>
      <span class="contact-btn-arrow" aria-hidden="true">â†’</span>
      <span class="contact-btn-spinner hidden" aria-hidden="true">
        <svg class="h-5 w-5 animate-spin" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" aria-hidden="true">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
      </span>
    </button>
  </form>
  <div class="mt-6 flex flex-col gap-4" aria-live="polite">
    <div id="contact-success" class="hidden rounded-lg border border-green-200 bg-green-50 p-4 text-green-800 dark:border-green-800 dark:bg-green-900/30 dark:text-green-200 transition-opacity duration-300" role="status"></div>
    <div id="contact-error" class="hidden rounded-lg border border-red-200 bg-red-50 p-4 text-sm text-red-800 dark:border-red-800 dark:bg-red-900/30 dark:text-red-200 transition-opacity duration-300" role="alert"></div>
  </div>
</div>
<script>
  import { animate } from 'motion';

  const form = document.getElementById('contact-form') as HTMLFormElement;
  const container = document.getElementById('contact-form-container');
  const successEl = document.getElementById('contact-success');
  const errorEl = document.getElementById('contact-error');
  const submitBtn = document.getElementById('contact-submit-btn') as HTMLButtonElement | null;
  const btnText = submitBtn?.querySelector('.contact-btn-text');
  const btnArrow = submitBtn?.querySelector('.contact-btn-arrow');
  const btnSpinner = submitBtn?.querySelector('.contact-btn-spinner');

  let dismissTimeout: ReturnType<typeof setTimeout> | null = null;

  function dismissAlert(el: HTMLElement) {
    dismissTimeout = null;
    animate(el, { opacity: [1, 0] }, { duration: 0.3, ease: 'easeOut' }).then(() => {
      el.classList.add('hidden');
    });
  }

  function showSuccess(message: string) {
    if (!successEl || !container) return;
    if (dismissTimeout) clearTimeout(dismissTimeout);
    form?.classList.add('hidden');
    errorEl?.classList.add('hidden');
    successEl.textContent = message;
    successEl.classList.remove('hidden');
    successEl.style.opacity = '0';
    animate(successEl, { opacity: [0, 1], scale: [0.98, 1] }, { duration: 0.3, ease: 'easeOut' });
    dismissTimeout = setTimeout(() => dismissAlert(successEl), 4000);
  }

  function showError(message: string) {
    if (!errorEl) return;
    if (dismissTimeout) clearTimeout(dismissTimeout);
    errorEl.textContent = message;
    errorEl.classList.remove('hidden');
    errorEl.style.opacity = '0';
    animate(errorEl, { opacity: [0, 1], scale: [0.98, 1] }, { duration: 0.3, ease: 'easeOut' });
    dismissTimeout = setTimeout(() => dismissAlert(errorEl), 4000);
  }

  function setButtonLoading(loading: boolean) {
    if (!submitBtn || !btnText || !btnArrow || !btnSpinner) return;
    if (loading) {
      submitBtn.disabled = true;
      btnText.classList.add('hidden');
      btnArrow.classList.add('hidden');
      btnSpinner.classList.remove('hidden');
    } else {
      submitBtn.disabled = false;
      btnText.classList.remove('hidden');
      btnArrow.classList.remove('hidden');
      btnSpinner.classList.add('hidden');
    }
  }

  function clearFieldErrors() {
    ['name', 'email', 'message'].forEach((f) => {
      const err = document.getElementById(`contact-${f}-error`);
      if (err) {
        err.classList.add('hidden');
        err.textContent = '';
      }
    });
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    clearFieldErrors();
    errorEl?.classList.add('hidden');
    successEl?.classList.add('hidden');
    if (dismissTimeout) {
      clearTimeout(dismissTimeout);
      dismissTimeout = null;
    }

    const name = (form.querySelector('#contact-name') as HTMLInputElement)?.value?.trim();
    const email = (form.querySelector('#contact-email') as HTMLInputElement)?.value?.trim();
    const message = (form.querySelector('#contact-message') as HTMLTextAreaElement)?.value?.trim();

    let valid = true;
    if (!name) {
      const el = document.getElementById('contact-name-error');
      if (el) { el.textContent = 'Name is required'; el.classList.remove('hidden'); }
      valid = false;
    }
    if (!email) {
      const el = document.getElementById('contact-email-error');
      if (el) { el.textContent = 'Email is required'; el.classList.remove('hidden'); }
      valid = false;
    }
    if (!message) {
      const el = document.getElementById('contact-message-error');
      if (el) { el.textContent = 'Message is required'; el.classList.remove('hidden'); }
      valid = false;
    }

    if (!valid) {
      showError(container?.dataset?.contactErrorMsg ?? 'Please fill all fields correctly.');
      return;
    }

    setButtonLoading(true);

    try {
      const res = await fetch('/api/contact', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, email, message }),
      });
      const data = await res.json().catch(() => ({}));

      if (res.ok && data.success) {
        const successMsg = container?.dataset?.contactSuccessMsg ?? 'Message sent. I\'ll get back to you soon.';
        showSuccess(successMsg);
      } else {
        showError(data?.error ?? container?.dataset?.contactErrorMsg ?? 'Something went wrong. Please try again.');
      }
    } catch {
      showError(container?.dataset?.contactErrorMsg ?? 'Network error. Please try again.');
    } finally {
      setButtonLoading(false);
    }
  });
</script>
